<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>외화 거래</title>
    <link rel="stylesheet" href="/CSS/main.css">
</head>
<body>
    <nav>
        <ul class="mainMenu">
            <% if (userId) { %>
            <li><a href="/"><img src="" alt="로고"></a></li>
            <li><a>주식 거래</a>
                <ul class="subMenu">
                    <li><a href="/stock_search">검색</a></li>
                    <li><a href="/stock_transaction">매수 / 매도</a></li>
                </ul>
            </li>
            <li><a>외화 거래</a>
                <ul class="subMenu">
                    <li><a href="/currency_search">검색</a></li>
                    <li><a href="/currency_transaction">매수 / 매도</a></li>
                </ul>
            </li>
            <li><a>명예의 전당</a>
                <ul class="subMenu">
                    <li><a href="/best_earner">역대 최고 수익자</a></li>
                    <li><a href="/richest_person">최고의 자산가</a></li>
                </ul>
            </li>
            <li><a>게임</a>
                <ul class="subMenu">
                    <li><a href="#">복권</a></li>
                    <li><a href="#">룰렛</a></li>
                    <li><a href="#">주사위</a></li>
                </ul>
            </li>
            <li class="userInfo">
                <a>사용자 이름: <%= userId %></a>
                <ul class="subMenu">
                    <li><a href="#">내 정보</a></li>
                    <li><a href="#">내 자산</a></li>
                    <li><a href="/logout">로그아웃</a></li>
                </ul>
            </li>
            <% } else { %>
                <li><a href="/"><img src="" alt="로고"></a></li>
            <li><a>주식 거래</a>
                <ul class="subMenu">
                    <li><a href="#" onclick="checkLogin(event)">검색</a></li>
                    <li><a href="#" onclick="checkLogin(event)">매수 / 매도</a></li>
                </ul>
            </li>
            <li><a>외화 거래</a>
                <ul class="subMenu">
                    <li><a href="#" onclick="checkLogin(event)">검색</a></li>
                    <li><a href="#" onclick="checkLogin(event)">매수 / 매도</a></li>
                </ul>
            </li>
            <li><a>명예의 전당</a>
                <ul class="subMenu">
                    <li><a href="#" onclick="checkLogin(event)">역대 최고 수익자</a></li>
                    <li><a href="#" onclick="checkLogin(event)">최고의 자산가</a></li>
                </ul>
            </li>
            <li><a>게임</a>
                <ul class="subMenu">
                    <li><a href="#" onclick="checkLogin(event)">복권</a></li>
                    <li><a href="#" onclick="checkLogin(event)">룰렛</a></li>
                    <li><a href="#" onclick="checkLogin(event)">주사위</a></li>
                </ul>
            </li>
                <li><a href="/login">로그인</a></li>
                <li><a href="/signin">회원가입</a></li>
            <% } %>
        </ul>
    </nav>
    <div class="currency_search-container">
        <form action="/currency_transaction" method="post">
            <input type="text" name="query" class="currency_search-box" placeholder="외화 심볼을 입력해주세요 ex)USD">
            <button type="submit" class="currency_search-button">검색</button>
        </form>
    </div>
    <div class="currencyList"></div>
    <% if (userId) { %>
        <footer>
            <h3>사이트맵</h3>
            <ul class="siteMap">
                <li><a href="/">홈</a></li>
                <li>
                    <a>주식</a>
                    <ul class="subSiteMap">
                        <li><a href="/stock_search">주식 검색</a></li>
                        <li><a href="/stock_transaction">주식 거래</a></li>
                    </ul>
                </li>
                <li>
                    <a>외화</a>
                    <ul class="subSiteMap">
                        <li><a href="/currency_search">외화 검색</a></li>
                        <li><a href="/currency_transaction">외화 거래</a></li>
                    </ul>
                </li>
                <li>
                    <a>명예의 전당</a>
                    <ul class="subSiteMap">
                        <li><a href="/best_earner">역대 최고 수익자</a></li>
                        <li><a href="/richest_person">최고의 자산가</a></li>
                    </ul>
                </li>
                <li>
                    <a>게임</a>
                    <ul class="subSiteMap">
                        <li><a href="#">복권</a></li>
                        <li><a href="#">룰렛</a></li>
                        <li><a href="#">주사위</a></li>
                    </ul>
                </li>
                <li>
                    <a>사용자 정보</a>
                    <ul class="subSiteMap">
                        <li><a href="#">내 정보</a></li>
                        <li><a href="#">내 자산</a></li>
                    </ul>
                </li>
            </ul>
        </footer>
    <%} else { %>
        <footer>
            <h3>사이트맵</h3>
            <ul class="siteMap">
                <li><a href="/">홈</a></li>
                <li>
                    <a>주식 거래</a>
                    <ul class="subSiteMap">
                        <li><a href="#" onclick="checkLogin(event)">주식 검색</a></li>
                        <li><a href="#" onclick="checkLogin(event)">주식 거래</a></li>
                    </ul>
                </li>
                <li>
                    <a>외화 거래</a>
                    <ul class="subSiteMap">
                        <li><a href="#" onclick="checkLogin(event)">외화 검색</a></li>
                        <li><a href="#" onclick="checkLogin(event)">외화 거래</a></li>
                    </ul>
                </li>
                <li>
                    <a>명예의 전당</a>
                    <ul class="subSiteMap">
                        <li><a href="#" onclick="checkLogin(event)">역대 최고 수익자</a></li>
                        <li><a href="#" onclick="checkLogin(event)">최고의 자산가</a></li>
                    </ul>
                </li>
                <li>
                    <a>게임</a>
                    <ul class="subSiteMap">
                        <li><a href="#" onclick="checkLogin(event)">복권</a></li>
                        <li><a href="#" onclick="checkLogin(event)">룰렛</a></li>
                        <li><a href="#" onclick="checkLogin(event)">주사위</a></li>
                    </ul>
                </li>
                <li>
                    <a>사용자 정보</a>
                    <ul class="subSiteMap">
                        <li><a href="#" onclick="checkLogin(event)">내 정보</a></li>
                        <li><a href="#" onclick="checkLogin(event)">내 자산</a></li>
                    </ul>
                </li>
            </ul>
        </footer>
    <% } %>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="script/main.js"></script>
    <script>
        const money = '<%= money %>'
        function checkLogin(event) {
            event.preventDefault();
            alert('로그인이 필요한 기능입니다.')
            window.location.href = '/login';
        }
        function buyCurrency(currency, quantity, price) {
            if(money>=price*quantity){
                console.log(price);
                // 서버로 구매 요청을 보냄
                fetch('/buy_currency', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currency: currency,
                        quantity: quantity,
                        price : price
                    })
                })
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    if(data.error){
                        throw new Error(data.error);
                    }
                    // 서버로부터 받은 응답을 처리
                    alert('외화 매수 성공');
                    location.reload();
                })
                .catch(error => {
                    console.error('에러:', error);
                    alert('에러: ' + error);
                    location.reload();
                });
            }
            else{
                alert('보유중인 금액이 부족합니다.');
                location.reload();
            }
        }
        function sellCurrency(currency, quantity, price) {
            fetch('/sell_currency', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    currency: currency,
                    quantity: quantity,
                    price: price
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('외화 매도에 실패하였습니다.');
                }
                return response.json(); // 서버 응답에서 JSON 데이터를 추출합니다.
            })
            .then(data => {
                if(data.error){
                    throw new Error(data.error);
                    console.log(data.message);
                }
                console.log('외화를 성공적으로 판매하였습니다.');
                alert('외화 매도를 성공했습니다.');
                location.reload();
                // 판매 성공 후 수행할 작업을 추가할 수 있습니다.
            })
            .catch(error => {
                console.error('외화 판매 중 오류 발생:', error);
                // 판매 실패 시 수행할 작업을 추가할 수 있습니다.
                alert(error.message);
            });
        }
        function displayCurrencyResult(currency) {
            const currencyList = document.querySelector('.currencyList');

            // 결과를 출력하기 전에 이전에 출력된 내용을 모두 지웁니다.
            currencyList.innerHTML = '';

            const listItem = document.createElement('li');
            listItem.textContent = `${currency.countryName} - ${currency.symbol} 매수 : ${currency.buy} KRW 매도 : ${currency.sell} KRW`;

            // 수량 입력 필드 생성
            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.placeholder = '수량 입력';

            // 매수 버튼 생성
            const buyButton = document.createElement('button');
            buyButton.textContent = '매수';
            buyButton.addEventListener('click', function() {
                const quantity = parseInt(quantityInput.value);
                const price = currency.buy;
                if (!isNaN(quantity) && quantity > 0) {
                    buyCurrency(currency.countryName, quantity, price);
                } else {
                    console.error('올바른 수량을 입력하세요.');
                }
            });

            // 매도 버튼 생성
            const sellButton = document.createElement('button');
            sellButton.textContent = '매도';
            sellButton.addEventListener('click', function() {
                const quantity = parseInt(quantityInput.value);
                const price = currency.sell;
                if (!isNaN(quantity) && quantity > 0) {
                    sellCurrency(currency.countryName, quantity, price);
                } else {
                    console.error('올바른 수량을 입력하세요.');
                }
            });

            // 리스트 아이템에 수량 입력 필드와 버튼들을 추가합니다.
            listItem.appendChild(quantityInput);
            listItem.appendChild(buyButton);
            listItem.appendChild(sellButton);

            currencyList.appendChild(listItem);
        };
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('.currency_search-container form');
    
            form.addEventListener('submit', function(event) {
                event.preventDefault(); // 폼의 기본 동작 방지
    
                const query = form.querySelector('.currency_search-box').value.trim();
    
                if (query) {
                    fetch('/currency_transaction_search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ query: query })
                    })
                    .then(response => {
                        if (!response.ok) {
                            console.log('서버 응답이 실패했습니다.');
                        }
                        return response.json(); // JSON 형식의 응답을 파싱
                    })
                    .then(data => {
                        console.log(data);
                        if(data.error){
                            console.log(data);
                            throw Error(data.error);
                        }
                        displayCurrencyResult(data);
                    })
                    .catch(error => {
                        alert('에러 : ' + error.message);
                    });
                } else {
                    alert('외화 심볼을 입력하세요');
                }
            });
        });
    </script>
</body>
</html>